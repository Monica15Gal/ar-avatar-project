<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente Anat√≥mico AR - Coraz√≥n 3D</title>
    
    <!-- Three.js con import maps -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://threejs.org/build/three.module.js",
            "three/addons/": "https://threejs.org/examples/jsm/"
        }
    }
    </script>
    <script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>
    
    <!-- AR.js para Three.js -->
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@master/three.js/build/ar-threex.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@master/three.js/build/ar-threex-location-only.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #000;
            font-family: Arial, sans-serif;
        }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 10px;
            z-index: 100;
            max-width: 300px;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            text-align: center;
            background: rgba(0,0,0,0.7);
            padding: 20px;
            border-radius: 10px;
        }
        #c {
            display: block;
            width: 100vw;
            height: 100vh;
        }
        .debug {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: white;
            background: rgba(255,0,0,0.7);
            padding: 10px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="info">
        <h3>üß† Asistente Anat√≥mico AR</h3>
        <p>Enfoca un c√≥digo QR con valor "5"</p>
        <p><strong>Aplicaci√≥n:</strong> Educaci√≥n m√©dica</p>
        <p><small>Mant√©n el QR estable frente a la c√°mara</small></p>
    </div>
    
    <div id="loading">
        <p>üîÑ Inicializando c√°mara AR...</p>
        <p>Por favor permite el acceso a la c√°mara</p>
    </div>

    <div id="debug" class="debug" style="display: none;">
        Estado: Inicializando...
    </div>
    
    <canvas id="c"></canvas>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        
        // Elementos DOM
        const loadingElement = document.getElementById('loading');
        const debugElement = document.getElementById('debug');
        
        // ===== CONFIGURACI√ìN THREE.JS =====
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.01, 1000); // Rango ajustado
        const renderer = new THREE.WebGLRenderer({ 
            canvas: document.getElementById('c'),
            alpha: true,
            antialias: true,
            preserveDrawingBuffer: true
        });
        
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Limitar pixel ratio
        renderer.autoClear = false;
        
        // ===== CONFIGURACI√ìN AR.JS MEJORADA =====
        const arToolkitSource = new THREEx.ArToolkitSource({
            sourceType: 'webcam',
            sourceWidth: 640,  // Resoluci√≥n controlada
            sourceHeight: 480,
            displayWidth: window.innerWidth,
            displayHeight: window.innerHeight
        });
        
        const arToolkitContext = new THREEx.ArToolkitContext({
            cameraParametersUrl: 'https://raw.githack.com/AR-js-org/AR.js/master/three.js/data/camera_para.dat',
            detectionMode: 'mono',
            maxDetectionRate: 30,
            canvasWidth: 640,
            canvasHeight: 480,
            patternRatio: 0.75  // Mejor para QR
        });
        
        // ===== GRUPO DEL MARCADOR =====
        const markerRoot = new THREE.Group();
        scene.add(markerRoot);
        
        let arMarkerControls;
        
        // ===== INICIALIZACI√ìN MEJORADA =====
        function initializeAR() {
            debugElement.style.display = 'block';
            debugElement.textContent = 'Estado: Inicializando c√°mara...';
            
            arToolkitSource.init(function onReady() {
                debugElement.textContent = 'Estado: C√°mara lista, configurando AR...';
                
                // Ajustar tama√±o despu√©s de inicializar
                arToolkitSource.onResizeElement();
                arToolkitSource.copyElementSizeTo(renderer.domElement);
                
                arToolkitContext.init(function onCompleted() {
                    debugElement.textContent = 'Estado: AR configurado, cargando modelo...';
                    
                    // Configurar controles del marcador DESPU√âS de inicializar contexto
                    arMarkerControls = new THREEx.ArMarkerControls(arToolkitContext, markerRoot, {
                        type: 'barcode',
                        barcodeValue: '5',
                        patternUrl: null
                    });
                    
                    // Cargar modelo despu√©s de que todo est√© listo
                    loadHeartModel();
                });
            });
        }
        
        // ===== CARGAR MODELO DEL CORAZ√ìN =====
        function loadHeartModel() {
            const loader = new GLTFLoader();
            
            loadingElement.innerHTML = '<p>üîÑ Cargando modelo del coraz√≥n...</p>';
            
            // Usar modelo M√ÅS LIVIANO para mejor rendimiento
            loader.load(
                'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models/2.0/Box/glTF/Box.gltf', // Modelo simple por ahora
                (gltf) => {
                    const heartModel = gltf.scene;
                    
                    // Configuraci√≥n visual mejorada
                    heartModel.scale.set(0.3, 0.3, 0.3);
                    heartModel.position.set(0, 0.2, 0);
                    
                    // Material rojo para simular coraz√≥n
                    heartModel.traverse((child) => {
                        if (child.isMesh) {
                            child.material = new THREE.MeshPhongMaterial({
                                color: 0xff4444,
                                shininess: 50
                            });
                        }
                    });
                    
                    // Iluminaci√≥n b√°sica
                    const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
                    markerRoot.add(ambientLight);
                    
                    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
                    directionalLight.position.set(1, 1, 1);
                    markerRoot.add(directionalLight);
                    
                    markerRoot.add(heartModel);
                    
                    loadingElement.style.display = 'none';
                    debugElement.textContent = 'Estado: ‚úÖ Listo - Enfoca un QR con valor "5"';
                    
                    console.log('‚úÖ Sistema AR completamente inicializado');
                },
                (progress) => {
                    const percent = (progress.loaded / progress.total * 100).toFixed(0);
                    loadingElement.innerHTML = `<p>üîÑ Cargando modelo... ${percent}%</p>`;
                },
                (error) => {
                    console.error('Error cargando modelo:', error);
                    loadingElement.innerHTML = '<p>‚ùå Error cargando modelo</p>';
                    debugElement.textContent = 'Estado: Error en modelo';
                }
            );
        }
        
        // ===== ANIMACI√ìN MEJORADA =====
        function animate() {
            requestAnimationFrame(animate);
            
            if (arToolkitSource.ready && arToolkitContext.ready) {
                // Actualizar contexto AR
                arToolkitContext.update(arToolkitSource.domElement);
                
                // Actualizar matriz de proyecci√≥n de la c√°mara
                camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
                
                // Renderizar escena
                renderer.clear();
                renderer.render(scene, camera);
                
                // Debug info
                if (markerRoot.visible) {
                    debugElement.textContent = 'Estado: ‚úÖ QR Detectado - Modelo Visible';
                    debugElement.style.background = 'rgba(0,255,0,0.7)';
                }
            }
        }
        
        // ===== MANEJADORES DE EVENTOS =====
        window.addEventListener('resize', () => {
            // Solo ajustar si la fuente est√° lista
            if (arToolkitSource.ready) {
                arToolkitSource.onResizeElement();
                arToolkitSource.copyElementSizeTo(renderer.domElement);
            }
            
            // Ajustar c√°mara Three.js
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
        // Manejar errores de c√°mara
        arToolkitSource.domElement.addEventListener('error', (error) => {
            console.error('Error de c√°mara:', error);
            loadingElement.innerHTML = '<p>‚ùå Error de c√°mara</p><p>Verifica los permisos</p>';
            debugElement.textContent = 'Estado: Error de c√°mara';
        });
        
        // ===== INICIAR APLICACI√ìN =====
        initializeAR();
        animate();
        
    </script>
</body>
</html>
