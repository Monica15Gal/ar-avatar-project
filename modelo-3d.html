<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente Anat√≥mico AR - Coraz√≥n 3D</title>
    
    <!-- Three.js con import maps -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://threejs.org/build/three.module.js",
            "three/addons/": "https://threejs.org/examples/jsm/"
        }
    }
    </script>
    <script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>
    
    <!-- AR.js para Three.js -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #000;
            font-family: Arial, sans-serif;
        }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 10px;
            z-index: 100;
            max-width: 300px;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="info">
        <h3>üß† Asistente Anat√≥mico AR</h3>
        <p>Enfoca un c√≥digo QR con valor "5" para ver el modelo 3D del coraz√≥n humano</p>
        <p><strong>Aplicaci√≥n:</strong> Educaci√≥n m√©dica</p>
    </div>
    
    <div id="loading">
        <p>Cargando modelo 3D del coraz√≥n...</p>
        <p>Por favor espera</p>
    </div>
    
    <canvas id="c"></canvas>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        
        // ===== CONFIGURACI√ìN THREE.JS =====
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ 
            canvas: document.getElementById('c'),
            alpha: true,
            antialias: true
        });
        
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        
        // ===== CONFIGURACI√ìN AR.JS =====
        const arToolkitSource = new THREEx.ArToolkitSource({
            sourceType: 'webcam',
        });
        
        const arToolkitContext = new THREEx.ArToolkitContext({
            cameraParametersUrl: 'https://raw.githack.com/AR-js-org/AR.js/master/three.js/data/camera_para.dat',
            detectionMode: 'mono',
            patternRatio: 0.5,
        });
        
        // ===== GRUPO DEL MARCADOR QR =====
        const markerRoot = new THREE.Group();
        scene.add(markerRoot);
        
        // ===== CONTROLES DEL MARCADOR QR =====
        const arMarkerControls = new THREEx.ArMarkerControls(arToolkitContext, markerRoot, {
            type: 'barcode',
            barcodeValue: '5', // Valor del QR que detectar√°
        });
        
        // ===== CARGAR MODELO 3D DEL CORAZ√ìN =====
        const loader = new GLTFLoader();
        let heartModel;
        
        loader.load(
            'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models/2.0/Heart/glTF/Heart.gltf',
            (gltf) => {
                heartModel = gltf.scene;
                
                // Ajustar escala y posici√≥n del coraz√≥n
                heartModel.scale.set(0.8, 0.8, 0.8);
                heartModel.position.set(0, 0.3, 0);
                heartModel.rotation.x = Math.PI / 6; // Inclinar ligeramente
                
                // Configurar materiales para mejor visualizaci√≥n
                heartModel.traverse((child) => {
                    if (child.isMesh) {
                        child.material = new THREE.MeshPhongMaterial({
                            color: 0xff6b6b, // Color rojo cardiaco
                            shininess: 30,
                            transparent: true,
                            opacity: 0.9
                        });
                    }
                });
                
                // A√±adir iluminaci√≥n m√©dica realista
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                markerRoot.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(5, 10, 7);
                directionalLight.castShadow = true;
                markerRoot.add(directionalLight);
                
                const pointLight = new THREE.PointLight(0xff4444, 0.5, 10);
                pointLight.position.set(0, 2, 3);
                markerRoot.add(pointLight);
                
                // A√±adir etiqueta flotante
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = 256;
                canvas.height = 128;
                
                context.fillStyle = 'rgba(255, 107, 107, 0.9)';
                context.fillRect(0, 0, canvas.width, canvas.height);
                context.font = 'bold 24px Arial';
                context.fillStyle = 'white';
                context.textAlign = 'center';
                context.fillText('CORAZ√ìN HUMANO', canvas.width/2, 40);
                context.font = '16px Arial';
                context.fillText('Sistema Cardiovascular', canvas.width/2, 70);
                
                const texture = new THREE.CanvasTexture(canvas);
                const labelMaterial = new THREE.SpriteMaterial({ 
                    map: texture,
                    transparent: true 
                });
                const labelSprite = new THREE.Sprite(labelMaterial);
                labelSprite.scale.set(1.5, 0.75, 1);
                labelSprite.position.set(0, 1.2, 0);
                markerRoot.add(labelSprite);
                
                markerRoot.add(heartModel);
                document.getElementById('loading').style.display = 'none';
                
                console.log('‚úÖ Modelo del coraz√≥n cargado correctamente');
            },
            (progress) => {
                const percent = (progress.loaded / progress.total * 100).toFixed(2);
                document.getElementById('loading').innerHTML = `
                    <p>Cargando modelo 3D del coraz√≥n...</p>
                    <p>${percent}% completado</p>
                    <p><small>El modelo puede tardar unos segundos</small></p>
                `;
            },
            (error) => {
                console.error('‚ùå Error cargando modelo del coraz√≥n:', error);
                document.getElementById('loading').innerHTML = `
                    <p>‚ùå Error cargando el coraz√≥n</p>
                    <p><small>Intenta recargar la p√°gina</small></p>
                `;
            }
        );
        
        // ===== INICIALIZAR AR =====
        arToolkitSource.init(() => {
            arToolkitSource.onResizeElement();
            arToolkitSource.copyElementSizeTo(renderer.domElement);
            
            arToolkitContext.init(() => {
                camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
            });
        });
        
        // ===== ANIMACI√ìN =====
        function animate() {
            requestAnimationFrame(animate);
            
            // Actualizar AR.js
            if (arToolkitSource.ready) {
                arToolkitContext.update(arToolkitSource.domElement);
            }
            
            // Rotar coraz√≥n suavemente si est√° visible
            if (heartModel && markerRoot.visible) {
                heartModel.rotation.y += 0.005; // Rotaci√≥n lenta para estudio anat√≥mico
                
                // Efecto de latido sutil
                const scale = 0.8 + Math.sin(Date.now() * 0.003) * 0.02;
                heartModel.scale.set(scale, scale, scale);
            }
            
            renderer.render(scene, camera);
        }
        animate();
        
        // ===== AJUSTAR TAMA√ëO =====
        window.addEventListener('resize', () => {
            if (arToolkitSource.ready) {
                arToolkitSource.onResizeElement();
                arToolkitSource.copyElementSizeTo(renderer.domElement);
            }
            
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
    </script>
</body>
</html>
